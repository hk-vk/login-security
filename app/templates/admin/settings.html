{% extends "../base.html" %}

{% block extra_css %}
<link rel="stylesheet" href="{{ url_for('static', path='css/admin.css') }}">
<style>
/* Debug info */
.debug-section {
    position: fixed;
    bottom: 0;
    left: 0;
    right: 0;
    background: rgba(0,0,0,0.8);
    color: #fff;
    padding: 10px;
    font-family: monospace;
    z-index: 10000;
    max-height: 200px;
    overflow: auto;
    display: none; /* Hide by default */
}
.debug-toggle {
    position: fixed;
    bottom: 10px;
    right: 10px;
    background: rgba(0,0,0,0.5);
    color: white;
    border: none;
    border-radius: 4px;
    padding: 5px 10px;
    font-size: 12px;
    cursor: pointer;
    z-index: 10001;
}
.debug-toggle:hover {
    background: rgba(0,0,0,0.7);
}
</style>
{% endblock %}

{% block content %}
<!-- Debug info visible during development -->
<div class="debug-section" id="debugSection">
    <h4>Debug Info</h4>
    <p>Current User: {{ admin_user.id }} - {{ admin_user.email }}</p>
    <p>Settings Last Updated: {{ settings.updated_at }}</p>
    <p>Last Updated By: {{ settings.last_updated_by }}</p>
</div>
<button class="debug-toggle" id="debugToggle">Show Debug</button>

<div class="admin-container">
    <div class="admin-sidebar">
        <div class="sidebar-header">
            <i class="fas fa-shield-alt"></i>
            <h3>Admin Panel</h3>
        </div>
        <nav class="sidebar-nav">
            <a href="/admin/dashboard">
                <i class="fas fa-chart-line"></i>
                Dashboard
            </a>
            <a href="/admin/users">
                <i class="fas fa-users"></i>
                Users
            </a>
            <a href="/admin/logs">
                <i class="fas fa-history"></i>
                Activity Logs
            </a>
            <a href="/admin/settings" class="active">
                <i class="fas fa-cog"></i>
                Settings
            </a>
            <a href="/admin/maintenance">
                <i class="fas fa-tools"></i>
                Maintenance
            </a>
        </nav>
    </div>

    <div class="admin-main">
        <div class="admin-header">
            <h2>System Settings</h2>
            <div class="header-actions">
                <button class="btn-primary" onclick="saveAllSettings()">
                    <i class="fas fa-save"></i>
                    Save All Changes
                </button>
            </div>
        </div>

        <div class="settings-container">
            <!-- Account Security Settings -->
            <div class="settings-card">
                <div class="card-header">
                    <h3><i class="fas fa-lock"></i> Account Security</h3>
                </div>
                <div class="card-body">
                    <div class="setting-item">
                        <div class="setting-info">
                            <label>Password Requirements</label>
                            <p>Set minimum requirements for user passwords</p>
                        </div>
                        <div class="setting-controls">
                            <div class="form-group">
                                <label>Minimum Length</label>
                                <input type="number" id="minPasswordLength" value="8" min="6" max="24">
                            </div>
                            <div class="form-group">
                                <label>Required Character Types</label>
                                <div class="checkbox-group">
                                    <label class="checkbox-label">
                                        <input type="checkbox" checked id="requireUppercase"> Uppercase
                                    </label>
                                    <label class="checkbox-label">
                                        <input type="checkbox" checked id="requireLowercase"> Lowercase
                                    </label>
                                    <label class="checkbox-label">
                                        <input type="checkbox" checked id="requireNumbers"> Numbers
                                    </label>
                                    <label class="checkbox-label">
                                        <input type="checkbox" checked id="requireSpecial"> Special Characters
                                    </label>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="setting-item">
                        <div class="setting-info">
                            <label>Account Lockout</label>
                            <p>Lock accounts after failed login attempts</p>
                        </div>
                        <div class="setting-controls">
                            <div class="toggle-switch">
                                <input type="checkbox" id="enableLockout" checked>
                                <label for="enableLockout"></label>
                            </div>
                            <div class="form-group inline-group">
                                <label>Max Attempts</label>
                                <input type="number" id="maxLoginAttempts" value="5" min="3" max="10">
                            </div>
                            <div class="form-group inline-group">
                                <label>Lockout Duration</label>
                                <div class="input-suffix">
                                    <input type="number" id="lockoutDuration" value="30" min="5">
                                    <span>minutes</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Authentication Settings -->
            <div class="settings-card">
                <div class="card-header">
                    <h3><i class="fas fa-user-shield"></i> Authentication</h3>
                </div>
                <div class="card-body">
                    <div class="setting-item">
                        <div class="setting-info">
                            <label>Multi-Factor Authentication</label>
                            <p>Enable MFA requirements for users</p>
                        </div>
                        <div class="setting-controls">
                            <div class="radio-group">
                                <label class="radio-label">
                                    <input type="radio" name="mfaPolicy" value="optional" checked> Optional
                                </label>
                                <label class="radio-label">
                                    <input type="radio" name="mfaPolicy" value="admins"> Required for Admins
                                </label>
                                <label class="radio-label">
                                    <input type="radio" name="mfaPolicy" value="all"> Required for All Users
                                </label>
                            </div>
                        </div>
                    </div>
                    <div class="setting-item">
                        <div class="setting-info">
                            <label>CAPTCHA Protection</label>
                            <p>Apply CAPTCHA to prevent automated attacks</p>
                        </div>
                        <div class="setting-controls">
                            <div class="checkbox-group">
                                <label class="checkbox-label">
                                    <input type="checkbox" checked id="enableLoginCaptcha"> Login Form
                                </label>
                                <label class="checkbox-label">
                                    <input type="checkbox" checked id="enableRegisterCaptcha"> Registration Form
                                </label>
                                <label class="checkbox-label">
                                    <input type="checkbox" checked id="enableResetCaptcha"> Password Reset
                                </label>
                            </div>
                        </div>
                    </div>
                    <div class="setting-item">
                        <div class="setting-info">
                            <label>Session Management</label>
                            <p>Configure user session settings</p>
                        </div>
                        <div class="setting-controls">
                            <div class="form-group">
                                <label>Session Timeout</label>
                                <div class="input-suffix">
                                    <input type="number" id="sessionTimeout" value="30" min="5" max="1440">
                                    <span>minutes</span>
                                </div>
                            </div>
                            <div class="toggle-switch with-label">
                                <input type="checkbox" id="enforceSingleSession" checked>
                                <label for="enforceSingleSession"></label>
                                <span>Limit to one active session per user</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Email Settings -->
            <div class="settings-card">
                <div class="card-header">
                    <h3><i class="fas fa-envelope"></i> Email Configuration</h3>
                </div>
                <div class="card-body">
                    <div class="setting-item">
                        <div class="setting-info">
                            <label>SMTP Settings</label>
                            <p>Configure outgoing email service</p>
                        </div>
                        <div class="setting-controls">
                            <div class="form-group">
                                <label>SMTP Server</label>
                                <input type="text" id="smtpServer" value="smtp.example.com">
                            </div>
                            <div class="form-group">
                                <label>SMTP Port</label>
                                <input type="number" id="smtpPort" value="587">
                            </div>
                            <div class="form-row">
                                <div class="form-group half">
                                    <label>Username</label>
                                    <input type="text" id="smtpUsername" value="notifications@example.com">
                                </div>
                                <div class="form-group half">
                                    <label>Password</label>
                                    <input type="password" id="smtpPassword" value="••••••••">
                                </div>
                            </div>
                            <div class="toggle-switch with-label">
                                <input type="checkbox" id="enableTLS" checked>
                                <label for="enableTLS"></label>
                                <span>Use TLS encryption</span>
                            </div>
                            <button class="btn-secondary" onclick="testEmailSettings()">
                                <i class="fas fa-paper-plane"></i>
                                Test Connection
                            </button>
                        </div>
                    </div>
                    <div class="setting-item">
                        <div class="setting-info">
                            <label>Email Notifications</label>
                            <p>Configure system notification emails</p>
                        </div>
                        <div class="setting-controls">
                            <div class="checkbox-group">
                                <label class="checkbox-label">
                                    <input type="checkbox" checked id="notifyRegistration"> New User Registrations
                                </label>
                                <label class="checkbox-label">
                                    <input type="checkbox" checked id="notifyFailedLogins"> Failed Login Attempts
                                </label>
                                <label class="checkbox-label">
                                    <input type="checkbox" checked id="notifyPasswordResets"> Password Resets
                                </label>
                                <label class="checkbox-label">
                                    <input type="checkbox" id="notifySystemErrors"> System Errors
                                </label>
                            </div>
                            <div class="form-group">
                                <label>Admin Notification Email</label>
                                <input type="email" id="adminEmail" value="admin@example.com">
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- System Settings -->
            <div class="settings-card">
                <div class="card-header">
                    <h3><i class="fas fa-cogs"></i> System</h3>
                </div>
                <div class="card-body">
                    <div class="setting-item">
                        <div class="setting-info">
                            <label>Logging</label>
                            <p>Configure system logging settings</p>
                        </div>
                        <div class="setting-controls">
                            <div class="form-group">
                                <label>Log Level</label>
                                <select id="logLevel">
                                    <option>Debug</option>
                                    <option selected>Info</option>
                                    <option>Warning</option>
                                    <option>Error</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label>Log Retention</label>
                                <div class="input-suffix">
                                    <input type="number" id="logRetention" value="30" min="7" max="365">
                                    <span>days</span>
                                </div>
                            </div>
                            <div class="toggle-switch with-label">
                                <input type="checkbox" id="enableAuditLog" checked>
                                <label for="enableAuditLog"></label>
                                <span>Enable detailed audit logging</span>
                            </div>
                        </div>
                    </div>
                    <div class="setting-item">
                        <div class="setting-info">
                            <label>Registration</label>
                            <p>Control user registration settings</p>
                        </div>
                        <div class="setting-controls">
                            <div class="toggle-switch with-label">
                                <input type="checkbox" id="allowRegistration" checked>
                                <label for="allowRegistration"></label>
                                <span>Allow new user registration</span>
                            </div>
                            <div class="toggle-switch with-label">
                                <input type="checkbox" id="requireEmailVerification" checked>
                                <label for="requireEmailVerification"></label>
                                <span>Require email verification</span>
                            </div>
                            <div class="toggle-switch with-label">
                                <input type="checkbox" id="requireAdminApproval">
                                <label for="requireAdminApproval"></label>
                                <span>Require admin approval for new accounts</span>
                            </div>
                        </div>
                    </div>
                    <div class="setting-item">
                        <div class="setting-info">
                            <label>Maintenance Mode</label>
                            <p>Take the system offline for maintenance</p>
                        </div>
                        <div class="setting-controls">
                            <div class="toggle-switch with-label">
                                <input type="checkbox" id="maintenanceMode">
                                <label for="maintenanceMode"></label>
                                <span>Enable maintenance mode</span>
                            </div>
                            <div class="form-group">
                                <label>Maintenance Message</label>
                                <textarea id="maintenanceMessage" rows="3">The system is currently undergoing scheduled maintenance. Please try again later.</textarea>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
// Toggle debug section
document.getElementById('debugToggle').addEventListener('click', function() {
    const debugSection = document.getElementById('debugSection');
    if (debugSection.style.display === 'none' || !debugSection.style.display) {
        debugSection.style.display = 'block';
        this.textContent = 'Hide Debug';
    } else {
        debugSection.style.display = 'none';
        this.textContent = 'Show Debug';
    }
});

// Save all settings
function saveAllSettings() {
    // Get form data for all settings sections
    const formData = {
        // Password policy
        password_min_length: parseInt(document.getElementById('minPasswordLength').value),
        password_require_uppercase: document.getElementById('requireUppercase').checked,
        password_require_lowercase: document.getElementById('requireLowercase').checked,
        password_require_digits: document.getElementById('requireNumbers').checked,
        password_require_special: document.getElementById('requireSpecial').checked,
        password_expiry_days: parseInt(document.getElementById('passwordExpiryDays').value),
        password_history_count: parseInt(document.getElementById('passwordHistoryCount').value),
        
        // Account lockout
        max_login_attempts: parseInt(document.getElementById('maxLoginAttempts').value),
        lockout_duration_minutes: parseInt(document.getElementById('lockoutDuration').value),
        
        // MFA
        require_mfa: document.querySelector('input[name="mfaPolicy"]:checked').value === 'all' || document.querySelector('input[name="mfaPolicy"]:checked').value === 'admins',
        mfa_remember_days: parseInt(document.getElementById('mfaRememberDays').value),
        
        // Session
        session_timeout_minutes: parseInt(document.getElementById('sessionTimeout').value)
    };
    
    // Send AJAX request to save settings
    fetch('/admin/settings', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify(formData)
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showToast('Settings saved successfully', 'success');
        } else {
            showToast('Error: ' + data.message, 'error');
        }
    })
    .catch(error => {
        console.error('Error saving settings:', error);
        showToast('An error occurred while saving settings', 'error');
    });
}

// Toast notification function
function showToast(message, type) {
    const toast = document.createElement('div');
    toast.className = `toast ${type}`;
    toast.innerHTML = message;
    document.body.appendChild(toast);
    
    // Show toast
    setTimeout(() => {
        toast.classList.add('show');
    }, 10);
    
    // Hide and remove toast after 3 seconds
    setTimeout(() => {
        toast.classList.remove('show');
        setTimeout(() => {
            toast.remove();
        }, 300);
    }, 3000);
}

// Test email settings
function testEmailSettings() {
    const settings = {
        server: document.getElementById('smtpServer').value,
        port: parseInt(document.getElementById('smtpPort').value),
        username: document.getElementById('smtpUsername').value,
        password: document.getElementById('smtpPassword').value,
        tls: document.getElementById('enableTLS').checked,
        testEmail: document.getElementById('adminEmail').value
    };

    // Send test email
    fetch('/admin/settings/test-email', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify(settings)
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showNotification('Test email sent successfully', 'success');
        } else {
            showNotification('Failed to send test email: ' + data.message, 'error');
        }
    })
    .catch(error => {
        console.error('Error testing email:', error);
        showNotification('An error occurred while testing email settings', 'error');
    });
}

// Show notification
function showNotification(message, type) {
    // Create notification element
    const notification = document.createElement('div');
    notification.className = `notification ${type}`;
    notification.innerHTML = `
        <span>${message}</span>
        <button onclick="this.parentElement.remove()">×</button>
    `;
    
    // Add to document
    document.body.appendChild(notification);
    
    // Auto remove after 5 seconds
    setTimeout(() => {
        if (notification.parentElement) {
            notification.remove();
        }
    }, 5000);
}
</script>
{% endblock %} 