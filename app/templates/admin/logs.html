{% extends "admin/admin_base.html" %}

{% block title %}Admin Logs - Adaptive Login Security System{% endblock %}

{% block admin_content %}
<div class="admin-header">
    <h2><i class="fas fa-history"></i> Activity Logs</h2>
    <div class="header-actions">
        <div class="action-buttons">
            <button class="btn btn-secondary me-2" id="export-csv">
                <i class="fas fa-file-csv"></i> Export CSV
            </button>
            <button class="btn btn-secondary" id="export-json">
                <i class="fas fa-file-code"></i> Export JSON
            </button>
        </div>
    </div>
</div>

<!-- Filters -->
<div class="card mb-4">
    <div class="card-header">
        <h5 class="mb-0"><i class="fas fa-filter"></i> Filter Logs</h5>
    </div>
    <div class="card-body">
        <form action="/admin/logs" method="get" class="filter-form">
            <div class="row">
                <div class="col-md-3 mb-3">
                    <label for="start_date_str" class="form-label">Start Date</label>
                    <input type="date" class="form-control" id="start_date_str" name="start_date_str" 
                           value="{{ filters.start_date if filters.start_date else '' }}">
                </div>
                <div class="col-md-3 mb-3">
                    <label for="end_date_str" class="form-label">End Date</label>
                    <input type="date" class="form-control" id="end_date_str" name="end_date_str" 
                           value="{{ filters.end_date if filters.end_date else '' }}">
                </div>
                <div class="col-md-2 mb-3">
                    <label for="success" class="form-label">Status</label>
                    <select class="form-select" id="success" name="success">
                        <option value="">All</option>
                        <option value="true" {% if filters.success == True %}selected{% endif %}>Success</option>
                        <option value="false" {% if filters.success == False %}selected{% endif %}>Failure</option>
                    </select>
                </div>
                <div class="col-md-2 mb-3">
                    <label for="user_id" class="form-label">User</label>
                    <select class="form-select" id="user_id" name="user_id">
                        <option value="">All Users</option>
                        {% for user_id, email in users.items() %}
                            <option value="{{ user_id }}" {% if filters.user_id|int == user_id %}selected{% endif %}>{{ email }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div class="col-md-2 mb-3">
                    <label for="ip_address" class="form-label">IP Address</label>
                    <input type="text" class="form-control" id="ip_address" name="ip_address" 
                           placeholder="IP Address" value="{{ filters.ip_address if filters.ip_address else '' }}">
                </div>
            </div>
            <div class="d-flex justify-content-end">
                <button type="submit" class="btn btn-primary">
                    <i class="fas fa-search"></i> Apply Filters
                </button>
                <a href="/admin/logs" class="btn btn-outline-secondary ms-2">
                    <i class="fas fa-times"></i> Clear
                </a>
            </div>
        </form>
    </div>
</div>

<!-- Logs Table -->
<div class="card">
    <div class="card-header d-flex justify-content-between align-items-center">
        <h5 class="mb-0"><i class="fas fa-list"></i> Login Activity Logs</h5>
        <span class="badge bg-primary">{{ total_items }} records</span>
    </div>
    <div class="card-body p-0">
        <div class="table-responsive">
            <table class="table table-hover table-striped mb-0">
                <thead>
                    <tr>
                        <th>Timestamp</th>
                        <th>User</th>
                        <th>IP Address</th>
                        <th>Status</th>
                        <th>Risk Score</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>
                    {% for log in logs %}
                        {% set user_email = users.get(log.user_id, 'Unknown') %}
                        <tr>
                            <td>{{ log.timestamp.strftime('%Y-%m-%d %H:%M:%S') }}</td>
                            <td>
                                {% if user_email != 'Unknown' %}
                                    <span class="user-initial">{{ user_email[0] | upper }}</span>
                                    {{ user_email }}
                                {% else %}
                                    <span class="text-muted">Unknown User (ID: {{ log.user_id }})</span>
                                {% endif %}
                            </td>
                            <td>{{ log.ip_address }}</td>
                            <td>
                                {% if log.success %}
                                    <span class="badge bg-success">Success</span>
                                {% else %}
                                    <span class="badge bg-danger">Failed</span>
                                    {% if log.failure_reason %}
                                        <small class="text-muted d-block">{{ log.failure_reason }}</small>
                                    {% endif %}
                                {% endif %}
                            </td>
                            <td>
                                {% if log.risk_score is not none %}
                                    <div class="risk-score 
                                        {% if log.risk_score > 70 %}high-risk
                                        {% elif log.risk_score > 40 %}medium-risk
                                        {% else %}low-risk{% endif %}">
                                        {{ log.risk_score }}
                                    </div>
                                {% else %}
                                    <span class="text-muted">N/A</span>
                                {% endif %}
                            </td>
                            <td>
                                <div class="btn-group">
                                    <button type="button" class="btn btn-sm btn-outline-info view-log" 
                                            data-log-id="{{ log.id }}"
                                            data-toggle="tooltip" 
                                            title="View Details">
                                        <i class="fas fa-eye"></i>
                                    </button>
                                    <button type="button" class="btn btn-sm btn-outline-danger delete-log" 
                                            data-log-id="{{ log.id }}"
                                            data-toggle="tooltip" 
                                            title="Delete Log">
                                        <i class="fas fa-trash"></i>
                                    </button>
                                </div>
                            </td>
                        </tr>
                    {% else %}
                        <tr>
                            <td colspan="6" class="text-center p-4">
                                <div class="empty-state">
                                    <i class="fas fa-search fa-3x text-muted mb-3"></i>
                                    <h5>No logs found</h5>
                                    <p class="text-muted">Try adjusting your filters to see more results.</p>
                                </div>
                            </td>
                        </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
    {% if total_pages > 1 %}
    <div class="card-footer">
        <nav aria-label="Log navigation">
            <ul class="pagination justify-content-center mb-0">
                <li class="page-item {% if current_page == 1 %}disabled{% endif %}">
                    <a class="page-link" href="?page=1{% for key, value in filters.items() %}{% if value %}&{{ key }}={{ value }}{% endif %}{% endfor %}" aria-label="First">
                        <span aria-hidden="true">&laquo;&laquo;</span>
                    </a>
                </li>
                <li class="page-item {% if current_page == 1 %}disabled{% endif %}">
                    <a class="page-link" href="?page={{ current_page - 1 }}{% for key, value in filters.items() %}{% if value %}&{{ key }}={{ value }}{% endif %}{% endfor %}" aria-label="Previous">
                        <span aria-hidden="true">&laquo;</span>
                    </a>
                </li>
                
                {% for p in range(max(1, current_page - 2), min(total_pages + 1, current_page + 3)) %}
                <li class="page-item {% if p == current_page %}active{% endif %}">
                    <a class="page-link" href="?page={{ p }}{% for key, value in filters.items() %}{% if value %}&{{ key }}={{ value }}{% endif %}{% endfor %}">{{ p }}</a>
                </li>
                {% endfor %}
                
                <li class="page-item {% if current_page == total_pages %}disabled{% endif %}">
                    <a class="page-link" href="?page={{ current_page + 1 }}{% for key, value in filters.items() %}{% if value %}&{{ key }}={{ value }}{% endif %}{% endfor %}" aria-label="Next">
                        <span aria-hidden="true">&raquo;</span>
                    </a>
                </li>
                <li class="page-item {% if current_page == total_pages %}disabled{% endif %}">
                    <a class="page-link" href="?page={{ total_pages }}{% for key, value in filters.items() %}{% if value %}&{{ key }}={{ value }}{% endif %}{% endfor %}" aria-label="Last">
                        <span aria-hidden="true">&raquo;&raquo;</span>
                    </a>
                </li>
            </ul>
        </nav>
    </div>
    {% endif %}
</div>

<!-- Log Detail Modal -->
<div class="modal fade" id="logModal" tabindex="-1" aria-labelledby="logModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="logModalLabel">Log Details</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body" id="logModalBody">
                <div class="text-center p-5">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>

<!-- Confirmation Modal -->
<div class="modal fade" id="confirmDeleteModal" tabindex="-1" aria-labelledby="confirmDeleteModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="confirmDeleteModalLabel">Confirm Delete</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                Are you sure you want to delete this log entry? This action cannot be undone.
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-danger" id="confirmDelete">Delete</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
{{ super() }}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // View log details
        document.querySelectorAll('.view-log').forEach(button => {
            button.addEventListener('click', function() {
                const logId = this.getAttribute('data-log-id');
                fetch(`/api/logs/${logId}`)
                    .then(response => response.json())
                    .then(data => {
                        const modalBody = document.getElementById('logModalBody');
                        
                        // Format the log details nicely
                        let content = `
                            <div class="log-details">
                                <table class="table table-sm table-borderless">
                                    <tr><th width="30%">Log ID:</th><td>${data.id}</td></tr>
                                    <tr><th>Timestamp:</th><td>${new Date(data.timestamp).toLocaleString()}</td></tr>
                                    <tr><th>User ID:</th><td>${data.user_id}</td></tr>
                                    <tr><th>Status:</th>
                                        <td>
                                            <span class="badge ${data.success ? 'bg-success' : 'bg-danger'}">
                                                ${data.success ? 'Success' : 'Failed'}
                                            </span>
                                        </td>
                                    </tr>
                                    <tr><th>IP Address:</th><td>${data.ip_address}</td></tr>
                                    <tr><th>User Agent:</th><td>${data.user_agent || 'Not recorded'}</td></tr>
                                    <tr><th>Location:</th><td>${data.location || 'Not recorded'}</td></tr>
                                    <tr><th>Device Fingerprint:</th><td>${data.device_fingerprint || 'Not recorded'}</td></tr>
                                    <tr><th>Risk Score:</th>
                                        <td>
                                            <div class="risk-score 
                                                ${data.risk_score > 70 ? 'high-risk' : data.risk_score > 40 ? 'medium-risk' : 'low-risk'}">
                                                ${data.risk_score !== null ? data.risk_score : 'N/A'}
                                            </div>
                                        </td>
                                    </tr>
                                    ${!data.success ? `<tr><th>Failure Reason:</th><td>${data.failure_reason || 'Unknown'}</td></tr>` : ''}
                                </table>
                            </div>
                        `;
                        
                        modalBody.innerHTML = content;
                        
                        // Show the modal
                        const modal = new bootstrap.Modal(document.getElementById('logModal'));
                        modal.show();
                    })
                    .catch(error => {
                        console.error('Error fetching log details:', error);
                        alert('Error loading log details. Please try again.');
                    });
            });
        });
        
        // Delete log
        let logToDelete = null;
        
        document.querySelectorAll('.delete-log').forEach(button => {
            button.addEventListener('click', function() {
                logToDelete = this.getAttribute('data-log-id');
                const modal = new bootstrap.Modal(document.getElementById('confirmDeleteModal'));
                modal.show();
            });
        });
        
        document.getElementById('confirmDelete').addEventListener('click', function() {
            if (logToDelete) {
                fetch(`/api/logs/${logToDelete}`, {
                    method: 'DELETE',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                })
                .then(response => {
                    if (response.ok) {
                        // Close the modal and reload the page
                        bootstrap.Modal.getInstance(document.getElementById('confirmDeleteModal')).hide();
                        window.location.reload();
                    } else {
                        throw new Error('Failed to delete log');
                    }
                })
                .catch(error => {
                    console.error('Error deleting log:', error);
                    alert('Error deleting log. Please try again.');
                });
            }
        });
        
        // Export buttons
        document.getElementById('export-csv').addEventListener('click', function() {
            exportLogs('csv');
        });
        
        document.getElementById('export-json').addEventListener('click', function() {
            exportLogs('json');
        });
        
        function exportLogs(format) {
            // Get current filter settings
            const params = new URLSearchParams(window.location.search);
            params.delete('page'); // Remove page parameter
            params.append('format', format);
            
            // Redirect to export URL with current filters
            window.location.href = `/admin/logs/export?${params.toString()}`;
        }
    });
</script>
{% endblock %} 