{% extends "base.html" %}

{% block extra_css %}
<link rel="stylesheet" href="{{ url_for('static', path='css/admin.css') }}">
<style>
/* Debug info */
.debug-section {
    position: fixed;
    bottom: 0;
    left: 0;
    right: 0;
    background: rgba(0,0,0,0.8);
    color: #fff;
    padding: 10px;
    font-family: monospace;
    z-index: 10000;
    max-height: 200px;
    overflow: auto;
    display: none; /* Hide by default */
}
.debug-toggle {
    position: fixed;
    bottom: 10px;
    right: 10px;
    background: rgba(0,0,0,0.5);
    color: white;
    border: none;
    border-radius: 4px;
    padding: 5px 10px;
    font-size: 12px;
    cursor: pointer;
    z-index: 10001;
}
.debug-toggle:hover {
    background: rgba(0,0,0,0.7);
}

/* Logs page specific styles */
.logs-filters {
    display: flex;
    flex-wrap: wrap;
    gap: 15px;
    margin-bottom: 20px;
    background: white;
    padding: 15px;
    border-radius: 8px;
    box-shadow: 0 2px 4px rgba(0,0,0,0.05);
}

.search-box {
    flex: 1;
    position: relative;
    min-width: 200px;
}

.search-box i {
    position: absolute;
    left: 12px;
    top: 50%;
    transform: translateY(-50%);
    color: #64748b;
}

.search-box input {
    width: 100%;
    padding: 10px 10px 10px 35px;
    border: 1px solid #e2e8f0;
    border-radius: 4px;
    font-size: 14px;
}

.filter-group {
    display: flex;
    gap: 10px;
    flex-wrap: wrap;
}

.filter-group select {
    min-width: 120px;
    padding: 8px 12px;
    border: 1px solid #e2e8f0;
    border-radius: 4px;
    font-size: 14px;
    color: #1e293b;
    background-color: white;
}

.date-range {
    display: flex;
    gap: 10px;
    align-items: center;
    flex-wrap: wrap;
}

.date-range button {
    padding: 8px 12px;
    background-color: #f1f5f9;
    border: none;
    border-radius: 4px;
    font-size: 14px;
    color: #1e293b;
    cursor: pointer;
}

.date-range button:hover {
    background-color: #e2e8f0;
}

.custom-date {
    display: flex;
    align-items: center;
    gap: 5px;
}

.custom-date input {
    width: 130px;
    padding: 8px;
    border: 1px solid #e2e8f0;
    border-radius: 4px;
    font-size: 14px;
}

.log-actions {
    display: flex;
    gap: 10px;
}

.btn-secondary {
    display: flex;
    align-items: center;
    gap: 5px;
    padding: 8px 12px;
    background-color: #f1f5f9;
    border: none;
    border-radius: 4px;
    font-size: 14px;
    color: #1e293b;
    cursor: pointer;
}

.btn-secondary:hover {
    background-color: #e2e8f0;
}

.logs-table-container {
    background-color: white;
    border-radius: 8px;
    box-shadow: 0 2px 4px rgba(0,0,0,0.05);
    overflow: hidden;
    margin-bottom: 20px;
}

.logs-table {
    width: 100%;
    border-collapse: collapse;
}

.logs-table th, .logs-table td {
    padding: 12px 16px;
    text-align: left;
    border-bottom: 1px solid #e2e8f0;
}

.logs-table th {
    background-color: #f8fafc;
    font-weight: 600;
    color: #64748b;
    font-size: 14px;
}

.logs-table tbody tr:hover {
    background-color: #f1f5f9;
}

.avatar-placeholder {
    width: 32px;
    height: 32px;
    background-color: #e2e8f0;
    color: #64748b;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: 600;
    margin-right: 8px;
}

.user-info {
    display: flex;
    align-items: center;
}

.log-description {
    max-width: 300px;
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
}

.action-buttons {
    display: flex;
    gap: 8px;
}

.badge {
    display: inline-flex;
    align-items: center;
    padding: 4px 8px;
    border-radius: 9999px;
    font-size: 12px;
    font-weight: 500;
}

.badge i {
    margin-right: 4px;
}

.event-auth {
    background-color: #dbeafe;
    color: #3b82f6;
}

.event-security {
    background-color: #fef9c3;
    color: #eab308;
}

.event-user {
    background-color: #dcfce7;
    color: #10b981;
}

.event-system {
    background-color: #f3f4f6;
    color: #9ca3af;
}

.severity-info {
    background-color: #dbeafe;
    color: #3b82f6;
}

.severity-warning {
    background-color: #fef9c3;
    color: #eab308;
}

.severity-error {
    background-color: #fee2e2;
    color: #ef4444;
}

.severity-critical {
    background-color: #fecaca;
    color: #dc2626;
}

.table-footer {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 16px;
    background-color: #f8fafc;
}

.entries-info {
    font-size: 14px;
    color: #64748b;
}

.pagination {
    display: flex;
    align-items: center;
    gap: 10px;
}

.page-numbers {
    display: flex;
    gap: 5px;
}

.page-numbers button {
    width: 32px;
    height: 32px;
    display: flex;
    align-items: center;
    justify-content: center;
    background-color: #f1f5f9;
    border: none;
    border-radius: 4px;
    color: #64748b;
    font-size: 14px;
}

.page-numbers button.active {
    background-color: #3b82f6;
    color: white;
}

.modal {
    display: none;
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background-color: rgba(0, 0, 0, 0.5);
    z-index: 1000;
    align-items: center;
    justify-content: center;
}

.modal-content {
    background-color: white;
    border-radius: 8px;
    width: 90%;
    max-width: 600px;
    max-height: 80vh;
    overflow-y: auto;
}

.modal-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 16px 24px;
    border-bottom: 1px solid #e2e8f0;
}

.modal-header h3 {
    margin: 0;
    font-size: 18px;
    font-weight: 600;
}

.modal-body {
    padding: 24px;
}

.log-details {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 16px;
}

.detail-group {
    margin-bottom: 16px;
}

.detail-group label {
    display: block;
    font-size: 12px;
    font-weight: 600;
    color: #64748b;
    margin-bottom: 4px;
}

.log-data {
    grid-column: 1 / -1;
    background-color: #f8fafc;
    padding: 12px;
    border-radius: 4px;
    font-family: monospace;
    font-size: 12px;
    overflow-x: auto;
}
</style>
{% endblock %}

{% block content %}
<!-- Debug info visible during development -->
<div class="debug-section" id="debugSection">
    <h4>Debug Info</h4>
    <p>Logs Count: {% if logs %}{{ logs|length }}{% else %}0{% endif %}</p>
    <p>Users: {{ users }}</p>
    <p>Page: {{ page }} of {{ total_pages }}</p>
    <p>Total Logs: {{ total_logs }}</p>
</div>
<button class="debug-toggle" id="debugToggle">Show Debug</button>

<div class="admin-container">
    <div class="admin-sidebar">
        <div class="sidebar-header">
            <i class="fas fa-shield-alt"></i>
            <h3>Admin Panel</h3>
        </div>
        <nav class="sidebar-nav">
            <a href="/admin/dashboard">
                <i class="fas fa-chart-line"></i>
                Dashboard
            </a>
            <a href="/admin/users">
                <i class="fas fa-users"></i>
                Users
            </a>
            <a href="/admin/security">
                <i class="fas fa-lock"></i>
                Security
            </a>
            <a href="/admin/logs" class="active">
                <i class="fas fa-history"></i>
                Activity Logs
            </a>
            <a href="/admin/settings">
                <i class="fas fa-cog"></i>
                Settings
            </a>
        </nav>
    </div>

    <div class="admin-main">
        <div class="admin-header">
            <h2>Activity Logs</h2>
            <div class="header-actions">
                <div class="date-range">
                    <button class="btn-secondary" onclick="setDateRange('today')">Today</button>
                    <button class="btn-secondary" onclick="setDateRange('week')">This Week</button>
                    <button class="btn-secondary" onclick="setDateRange('month')">This Month</button>
                    <div class="custom-date">
                        <input type="date" id="startDate">
                        <span>to</span>
                        <input type="date" id="endDate">
                        <button class="btn-secondary" onclick="applyCustomDate()">Apply</button>
                    </div>
                </div>
                <div class="log-actions">
                    <button class="btn-secondary" onclick="exportLogs()">
                        <i class="fas fa-download"></i>
                        Export
                    </button>
                    <button class="btn-secondary" onclick="clearLogs()">
                        <i class="fas fa-trash"></i>
                        Clear
                    </button>
                </div>
            </div>
        </div>

        <div class="logs-filters">
            <div class="search-box">
                <i class="fas fa-search"></i>
                <input type="text" id="logSearch" placeholder="Search logs..." onkeyup="filterLogs()">
            </div>
            <div class="filter-group">
                <select id="eventType" onchange="filterLogs()">
                    <option value="">All Event Types</option>
                    <option value="auth">Authentication</option>
                    <option value="security">Security</option>
                    <option value="user">User Activity</option>
                    <option value="system">System</option>
                </select>
                <select id="severity" onchange="filterLogs()">
                    <option value="">All Severities</option>
                    <option value="info">Info</option>
                    <option value="warning">Warning</option>
                    <option value="error">Error</option>
                    <option value="critical">Critical</option>
                </select>
                <select id="user" onchange="filterLogs()">
                    <option value="">All Users</option>
                    {% for user_id, user in users.items() %}
                    <option value="{{ user_id }}">{{ user.email }}</option>
                    {% endfor %}
                </select>
            </div>
        </div>

        <div class="logs-table-container">
            <table class="logs-table">
                <thead>
                    <tr>
                        <th>Timestamp</th>
                        <th>Event Type</th>
                        <th>User</th>
                        <th>IP Address</th>
                        <th>Description</th>
                        <th>Status</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>
                    {% for log in logs %}
                    <tr class="log-entry {% if not log.success %}error{% else %}info{% endif %}">
                        <td class="timestamp">{{ log.timestamp.strftime('%Y-%m-%d %H:%M:%S') }}</td>
                        <td>
                            <span class="badge event-auth">
                                <i class="fas fa-key"></i>
                                Authentication
                            </span>
                        </td>
                        <td>
                            {% if log.user_id in users %}
                            <div class="user-info">
                                <div class="avatar-placeholder">
                                    {{ users[log.user_id].email[0] | upper }}
                                </div>
                                <span>{{ users[log.user_id].email }}</span>
                            </div>
                            {% else %}
                            <span class="text-muted">Unknown</span>
                            {% endif %}
                        </td>
                        <td>{{ log.ip_address }}</td>
                        <td class="log-description">
                            {% if log.success %}
                            Successful login
                            {% else %}
                            Failed login{% if log.failure_reason %}: {{ log.failure_reason }}{% endif %}
                            {% endif %}
                        </td>
                        <td>
                            <span class="badge severity-{% if log.success %}info{% else %}error{% endif %}">
                                {% if log.success %}Success{% else %}Failed{% endif %}
                            </span>
                        </td>
                        <td>
                            <div class="action-buttons">
                                <button class="btn-icon" onclick="viewLogDetails({{ log.id }})">
                                    <i class="fas fa-eye"></i>
                                </button>
                                <button class="btn-icon delete" onclick="deleteLog({{ log.id }})">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>

        <div class="table-footer">
            <div class="entries-info">
                Showing <span id="startEntry">{{ (page - 1) * 25 + 1 }}</span> to <span id="endEntry">{{ [page * 25, total_logs] | min }}</span> of <span id="totalEntries">{{ total_logs }}</span> entries
            </div>
            <div class="pagination">
                <button class="btn-icon" onclick="changePage({{ page - 1 }})" {% if page <= 1 %}disabled{% endif %}>
                    <i class="fas fa-chevron-left"></i>
                </button>
                <div class="page-numbers">
                    {% for p in range(1, total_pages + 1) %}
                        {% if p == page %}
                            <button class="active">{{ p }}</button>
                        {% elif p <= 3 or p == total_pages or p >= page - 1 and p <= page + 1 %}
                            <button onclick="changePage({{ p }})">{{ p }}</button>
                        {% elif p == 4 and total_pages > 6 %}
                            <span>...</span>
                        {% endif %}
                    {% endfor %}
                </div>
                <button class="btn-icon" onclick="changePage({{ page + 1 }})" {% if page >= total_pages %}disabled{% endif %}>
                    <i class="fas fa-chevron-right"></i>
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Log Details Modal -->
<div id="logModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h3>Log Details</h3>
            <button class="btn-icon" onclick="closeModal()">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <div class="modal-body">
            <div class="log-details">
                <div class="detail-group">
                    <label>Event ID</label>
                    <span id="logId"></span>
                </div>
                <div class="detail-group">
                    <label>Timestamp</label>
                    <span id="logTimestamp"></span>
                </div>
                <div class="detail-group">
                    <label>Event Type</label>
                    <span id="logEventType"></span>
                </div>
                <div class="detail-group">
                    <label>User</label>
                    <span id="logUser"></span>
                </div>
                <div class="detail-group">
                    <label>IP Address</label>
                    <span id="logIp"></span>
                </div>
                <div class="detail-group">
                    <label>Description</label>
                    <span id="logDescription"></span>
                </div>
                <div class="detail-group">
                    <label>Status</label>
                    <span id="logStatus"></span>
                </div>
                <div class="detail-group">
                    <label>User Agent</label>
                    <span id="logUserAgent"></span>
                </div>
                <div class="detail-group log-data">
                    <label>Additional Data</label>
                    <pre id="logData"></pre>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
function setDateRange(range) {
    const today = new Date();
    let startDate = new Date();
    
    switch(range) {
        case 'today':
            startDate = today;
            break;
        case 'week':
            startDate.setDate(today.getDate() - 7);
            break;
        case 'month':
            startDate.setMonth(today.getMonth() - 1);
            break;
    }
    
    document.getElementById('startDate').value = startDate.toISOString().split('T')[0];
    document.getElementById('endDate').value = today.toISOString().split('T')[0];
    filterLogs();
}

function applyCustomDate() {
    filterLogs();
}

function filterLogs() {
    // Get filter values
    const searchText = document.getElementById('logSearch').value.toLowerCase();
    const eventType = document.getElementById('eventType').value;
    const severity = document.getElementById('severity').value;
    const userId = document.getElementById('user').value;
    
    // Prepare URL with filter parameters
    const url = new URL(window.location.href);
    url.searchParams.set('search', searchText);
    if (eventType) url.searchParams.set('event_type', eventType);
    if (severity) url.searchParams.set('severity', severity);
    if (userId) url.searchParams.set('user_id', userId);
    
    // Navigate to the filtered URL
    window.location.href = url.toString();
}

function changePage(page) {
    const url = new URL(window.location.href);
    url.searchParams.set('page', page);
    window.location.href = url.toString();
}

function viewLogDetails(logId) {
    // In a real implementation, fetch log details from the server
    fetch(`/admin/logs/${logId}/details`)
        .then(response => response.json())
        .then(log => {
            document.getElementById('logId').textContent = log.id;
            document.getElementById('logTimestamp').textContent = log.timestamp;
            document.getElementById('logEventType').textContent = log.event_type;
            document.getElementById('logUser').textContent = log.user_email;
            document.getElementById('logIp').textContent = log.ip_address;
            document.getElementById('logDescription').textContent = log.description;
            document.getElementById('logStatus').textContent = log.success ? 'Success' : 'Failed';
            document.getElementById('logUserAgent').textContent = log.user_agent;
            document.getElementById('logData').textContent = '{\n  "risk_score": 85,\n  "device_id": "unknown",\n  "location": {\n    "country": "Unknown",\n    "city": "Unknown"\n  }\n}';
            
            document.getElementById('logModal').style.display = 'flex';
        })
        .catch(error => {
            console.error('Error fetching log details:', error);
            alert('Failed to load log details');
            
            // For demo purposes, show the modal with placeholder data
            document.getElementById('logId').textContent = logId;
            document.getElementById('logTimestamp').textContent = new Date().toISOString();
            document.getElementById('logEventType').textContent = 'Authentication';
            document.getElementById('logUser').textContent = 'user@example.com';
            document.getElementById('logIp').textContent = '192.168.1.1';
            document.getElementById('logDescription').textContent = 'Login attempt';
            document.getElementById('logStatus').textContent = 'Failed';
            document.getElementById('logUserAgent').textContent = 'Mozilla/5.0 (Windows NT 10.0; Win64; x64)';
            document.getElementById('logData').textContent = '{\n  "risk_score": 85,\n  "device_id": "unknown",\n  "location": {\n    "country": "Unknown",\n    "city": "Unknown"\n  }\n}';
            
            document.getElementById('logModal').style.display = 'flex';
        });
}

function closeModal() {
    document.getElementById('logModal').style.display = 'none';
}

function deleteLog(logId) {
    if (confirm('Are you sure you want to delete this log?')) {
        fetch(`/admin/logs/${logId}/delete`, {
            method: 'POST'
        })
        .then(response => {
            if (response.ok) {
                window.location.reload();
            } else {
                alert('Failed to delete log');
            }
        })
        .catch(error => {
            console.error('Error deleting log:', error);
            alert('An error occurred');
        });
    }
}

function exportLogs() {
    alert('Exporting logs...');
    // In a real implementation, this would trigger a download
}

function clearLogs() {
    if (confirm('Are you sure you want to clear all logs? This action cannot be undone.')) {
        fetch('/admin/logs/clear', {
            method: 'POST'
        })
        .then(response => {
            if (response.ok) {
                window.location.reload();
            } else {
                alert('Failed to clear logs');
            }
        })
        .catch(error => {
            console.error('Error clearing logs:', error);
            alert('An error occurred');
        });
    }
}

// Debug toggle functionality
document.addEventListener('DOMContentLoaded', function() {
    document.getElementById('debugToggle').addEventListener('click', function() {
        const debugSection = document.getElementById('debugSection');
        const isVisible = debugSection.style.display === 'block';
        debugSection.style.display = isVisible ? 'none' : 'block';
        this.textContent = isVisible ? 'Show Debug' : 'Hide Debug';
    });
    
    // Set default date range to last 7 days
    setDateRange('week');
});

// Close modal when clicking outside
window.onclick = function(event) {
    const modal = document.getElementById('logModal');
    if (event.target === modal) {
        modal.style.display = 'none';
    }
};
</script>
{% endblock %} 