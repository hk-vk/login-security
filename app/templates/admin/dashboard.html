{% extends "base.html" %}

{% block title %}Admin Dashboard - Adaptive Login Security System{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{{ url_for('static', path='css/admin.css') }}">
<style>
body {
    margin: 0;
    padding: 0;
    overflow-x: hidden;
}
main {
    max-width: 100% !important;
    margin: 0 !important;
    padding: 0 !important;
}
/* Debug info */
.debug-section {
    position: fixed;
    bottom: 0;
    left: 0;
    right: 0;
    background: rgba(0,0,0,0.8);
    color: #fff;
    padding: 10px;
    font-family: monospace;
    z-index: 10000;
    max-height: 200px;
    overflow: auto;
}
</style>
{% endblock %}

{% block content %}
<!-- Debug info visible during development -->
<div class="debug-section">
    <h4>Debug Info (Remove in production)</h4>
    <p>User: {{ user }}</p>
    <p>Stats: {{ stats }}</p>
    <p>Security Metrics: {{ security_metrics }}</p>
    <p>System Status: {{ system_status }}</p>
    <p>Activities Count: {% if recent_activities %}{{ recent_activities|length }}{% else %}0{% endif %}</p>
    <p>Alerts Count: {% if critical_alerts %}{{ critical_alerts|length }}{% else %}0{% endif %}</p>
</div>

<div class="admin-container">
    <div class="admin-sidebar">
        <div class="sidebar-header">
            <i class="fas fa-shield-alt"></i>
            <h3>Admin Panel</h3>
        </div>
        <nav class="sidebar-nav">
            <a href="/admin/dashboard" class="active">
                <i class="fas fa-chart-line"></i>
                Dashboard
            </a>
            <a href="/admin/users">
                <i class="fas fa-users"></i>
                Users
            </a>
            <a href="/admin/security">
                <i class="fas fa-lock"></i>
                Security
            </a>
            <a href="/admin/logs">
                <i class="fas fa-history"></i>
                Activity Logs
            </a>
            <a href="/admin/settings">
                <i class="fas fa-cog"></i>
                Settings
            </a>
        </nav>
    </div>

    <div class="admin-main">
        <div class="admin-header">
            <h2>Security Dashboard</h2>
            <div class="header-actions">
                <div class="alert-indicator {% if stats and stats.critical_events > 0 %}alert-active{% endif %}">
                    <i class="fas fa-bell"></i>
                    <span class="alert-count">{{ stats.critical_events if stats else 0 }}</span>
                </div>
                <button class="btn-secondary" onclick="refreshStats()">
                    <i class="fas fa-sync"></i> Refresh
                </button>
                <div class="date-filter">
                    <select id="timeRange" onchange="updateStats()">
                        <option value="today">Today</option>
                        <option value="week">This Week</option>
                        <option value="month">This Month</option>
                        <option value="quarter">This Quarter</option>
                    </select>
                </div>
            </div>
        </div>

        <!-- System Status Banner -->
        <div class="system-status {% if system_status %}{{ system_status.level }}{% else %}normal{% endif %}">
            <i class="fas fa-{% if system_status and system_status.level != 'normal' %}exclamation-triangle{% else %}check-circle{% endif %}"></i>
            <span>System Status: {% if system_status %}{{ system_status.message }}{% else %}All systems operational{% endif %}</span>
            {% if system_status and system_status.level != 'normal' %}
            <button class="btn-small" onclick="showSystemDetails()">View Details</button>
            {% endif %}
        </div>

        <!-- Key Metrics Overview -->
        <div class="stats-grid">
            <div class="stat-card">
                <div class="stat-icon users">
                    <i class="fas fa-users"></i>
                </div>
                <div class="stat-info">
                    <h3>Total Users</h3>
                    <p class="stat-value">{{ stats.total_users if stats else 0 }}</p>
                    <p class="stat-change positive">+{{ stats.new_users if stats else 0 }} today</p>
                </div>
            </div>

            <div class="stat-card">
                <div class="stat-icon sessions">
                    <i class="fas fa-desktop"></i>
                </div>
                <div class="stat-info">
                    <h3>Active Sessions</h3>
                    <p class="stat-value">{{ stats.active_sessions if stats else 0 }}</p>
                    <p class="stat-change">{{ stats.total_sessions if stats else 0 }} total</p>
                </div>
            </div>

            <div class="stat-card">
                <div class="stat-icon security">
                    <i class="fas fa-shield-alt"></i>
                </div>
                <div class="stat-info">
                    <h3>Security Events</h3>
                    <p class="stat-value">{{ stats.security_events if stats else 0 }}</p>
                    <p class="stat-change negative">{{ stats.critical_events if stats else 0 }} critical</p>
                </div>
            </div>

            <div class="stat-card">
                <div class="stat-icon logins">
                    <i class="fas fa-sign-in-alt"></i>
                </div>
                <div class="stat-info">
                    <h3>Login Attempts</h3>
                    <p class="stat-value">{{ stats.login_attempts if stats else 0 }}</p>
                    <p class="stat-change negative">{{ stats.failed_logins if stats else 0 }} failed</p>
                </div>
            </div>
        </div>

        <!-- Security Overview -->
        <div class="dashboard-section">
            <div class="section-header">
                <h3><i class="fas fa-shield-alt"></i> Security Overview</h3>
                <button class="btn-small" onclick="location.href='/admin/security'">View All</button>
            </div>
            
            <div class="security-grid">
                <div class="security-card {% if security_metrics and security_metrics.login_failure_rate > 20 %}alert{% endif %}">
                    <h4>Login Failure Rate</h4>
                    <div class="metric-circle">
                        <span>{{ security_metrics.login_failure_rate if security_metrics else 0 }}%</span>
                    </div>
                    <p>Compared to 5% benchmark</p>
                </div>
                
                <div class="security-card {% if security_metrics and security_metrics.blocked_ips > 10 %}alert{% endif %}">
                    <h4>Blocked IPs</h4>
                    <div class="metric-value">
                        <i class="fas fa-ban"></i>
                        <span>{{ security_metrics.blocked_ips if security_metrics else 0 }}</span>
                    </div>
                    <p>{{ security_metrics.recent_blocks if security_metrics else 0 }} in last 24h</p>
                </div>
                
                <div class="security-card {% if security_metrics and security_metrics.mfa_adoption < 70 %}alert{% endif %}">
                    <h4>MFA Adoption</h4>
                    <div class="metric-circle">
                        <span>{{ security_metrics.mfa_adoption if security_metrics else 0 }}%</span>
                    </div>
                    <p>Target: 90%</p>
                </div>
                
                <div class="security-card {% if security_metrics and security_metrics.compliance_score < 80 %}alert{% endif %}">
                    <h4>Compliance Score</h4>
                    <div class="metric-circle">
                        <span>{{ security_metrics.compliance_score if security_metrics else 0 }}</span>
                    </div>
                    <p>{{ security_metrics.compliance_issues if security_metrics else 0 }} issues to resolve</p>
                </div>
            </div>
        </div>

        <!-- Charts placeholder - will be initialized by JavaScript -->
        <div class="charts-row">
            <div class="chart-card">
                <h3>User Activity Trends</h3>
                <div class="chart-container">
                    <canvas id="userActivityChart"></canvas>
                </div>
            </div>

            <div class="chart-card">
                <h3>Security Incidents</h3>
                <div class="chart-container">
                    <canvas id="securityChart"></canvas>
                </div>
            </div>
        </div>

        <!-- Quick Actions -->
        <div class="dashboard-section">
            <div class="section-header">
                <h3><i class="fas fa-bolt"></i> Quick Actions</h3>
            </div>
            
            <div class="quick-actions">
                <button class="action-button" onclick="lockdownSystem()">
                    <i class="fas fa-lock"></i>
                    <span>Lockdown System</span>
                </button>
                <button class="action-button" onclick="runSecurityScan()">
                    <i class="fas fa-search"></i>
                    <span>Run Security Scan</span>
                </button>
                <button class="action-button" onclick="createBackup()">
                    <i class="fas fa-database"></i>
                    <span>Create Backup</span>
                </button>
                <button class="action-button" onclick="location.href='/admin/settings'">
                    <i class="fas fa-cogs"></i>
                    <span>Security Policies</span>
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Store system data for JavaScript in hidden elements -->
<div id="dashboard-data" style="display:none;"
    data-cpu-usage="{{ system_status.cpu_usage if system_status and system_status.cpu_usage else 0 }}"
    data-memory-usage="{{ system_status.memory_usage if system_status and system_status.memory_usage else 0 }}" 
    data-disk-usage="{{ system_status.disk_usage if system_status and system_status.disk_usage else 0 }}">
</div>
{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    try {
        console.log("Initializing admin dashboard...");
        
        // Initialize charts with error handling
        function initCharts() {
            try {
                // User Activity Chart
                const userCtx = document.getElementById('userActivityChart');
                if (userCtx) {
                    new Chart(userCtx.getContext('2d'), {
                        type: 'line',
                        data: {
                            labels: ['Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat', 'Sun'],
                            datasets: [{
                                label: 'Active Users',
                                data: [65, 59, 80, 81, 56, 55, 40],
                                borderColor: '#3498db',
                                tension: 0.4,
                                fill: false
                            }, {
                                label: 'Authentication Failures',
                                data: [10, 15, 8, 12, 17, 14, 9],
                                borderColor: '#e74c3c',
                                tension: 0.4,
                                fill: false
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false
                        }
                    });
                }

                // Security Incidents Chart
                const securityCtx = document.getElementById('securityChart');
                if (securityCtx) {
                    new Chart(securityCtx.getContext('2d'), {
                        type: 'bar',
                        data: {
                            labels: ['Failed Logins', 'Suspicious IPs', 'MFA Failures', 'Password Attempts', 'Brute Force'],
                            datasets: [{
                                label: 'Incidents',
                                data: [12, 19, 3, 5, 8],
                                backgroundColor: '#e74c3c'
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false
                        }
                    });
                }
            } catch (error) {
                console.error('Error initializing charts:', error);
            }
        }

        // Initialize charts when the page loads
        window.setTimeout(initCharts, 100);

        // Make functions globally available
        window.refreshStats = function() {
            console.log('Refreshing stats...');
            alert('Dashboard data refreshed');
        };

        window.updateStats = function() {
            console.log('Updating stats');
            alert('Dashboard updated');
        };

        window.showSystemDetails = function() {
            alert('System details would display here');
        };

        window.lockdownSystem = function() {
            if (confirm('WARNING: This will lock all user accounts and invalidate all sessions. Continue?')) {
                alert('System lockdown initiated');
            }
        };

        window.runSecurityScan = function() {
            alert('Security scan initiated');
        };

        window.createBackup = function() {
            alert('System backup initiated');
        };

        console.log("Admin dashboard initialization complete!");
    } catch (error) {
        console.error("Fatal error initializing admin dashboard:", error);
        document.body.innerHTML += `
            <div style="position:fixed; top:0; left:0; right:0; background:red; color:white; padding:20px; z-index:10000">
                JavaScript Error: ${error.message}<br>
                <pre>${error.stack}</pre>
            </div>
        `;
    }
});
</script>
{% endblock %} 