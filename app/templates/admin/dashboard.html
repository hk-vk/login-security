{% extends "base.html" %}

{% block title %}Admin Dashboard - Adaptive Login Security System{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{{ url_for('static', path='css/admin.css') }}">
<style>
body {
    margin: 0;
    padding: 0;
    overflow-x: hidden;
}
main {
    max-width: 100%;
    margin: 0;
    padding: 0;
}
/* Progress bars are initialized with 0 width and updated by JavaScript */
.admin-progress-bar {
    width: 0%;
}
.admin-memory-bar {
    width: 0%;
}
.admin-disk-bar {
    width: 0%;
}
/* Debug info */
.debug-section {
    position: fixed;
    bottom: 0;
    left: 0;
    right: 0;
    background: rgba(0,0,0,0.8);
    color: #fff;
    padding: 10px;
    font-family: monospace;
    z-index: 10000;
    max-height: 200px;
    overflow: auto;
}
.admin-container {
    padding: 20px;
    max-width: 1200px;
    margin: 0 auto;
}

.stats-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
    gap: 20px;
    margin-bottom: 20px;
}

.stat-card {
    background: #fff;
    border-radius: 8px;
    box-shadow: 0 2px 5px rgba(0,0,0,0.1);
    padding: 20px;
}

.stat-title {
    font-size: 16px;
    color: #555;
    margin-bottom: 10px;
}

.stat-value {
    font-size: 28px;
    font-weight: bold;
    color: #2c3e50;
}

.stat-extra {
    font-size: 14px;
    color: #888;
    margin-top: 5px;
}

.positive {
    color: #2ecc71;
}

.negative {
    color: #e74c3c;
}

.section-header {
    margin: 30px 0 15px;
    padding-bottom: 10px;
    border-bottom: 1px solid #eee;
}

.debug-box {
    margin-top: 50px;
    padding: 15px;
    background: #f8f9fa;
    border-radius: 5px;
    border-left: 4px solid #3498db;
}

.debug-box pre {
    white-space: pre-wrap;
    font-size: 12px;
}
</style>
{% endblock %}

{% block content %}
<!-- Debug info visible during development -->
<div class="debug-section">
    <h4>Debug Info (Remove in production)</h4>
    <p>User: {{ user }}</p>
    <p>Stats: {{ stats }}</p>
    <p>Security Metrics: {{ security_metrics }}</p>
    <p>System Status: {{ system_status }}</p>
    <p>Activities Count: {% if recent_activity %}{{ recent_activity|length }}{% else %}0{% endif %}</p>
    <p>Alerts Count: {% if critical_alerts %}{{ critical_alerts|length }}{% else %}0{% endif %}</p>
</div>

<div class="admin-container">
    <div class="admin-sidebar">
        <div class="sidebar-header">
            <i class="fas fa-shield-alt"></i>
            <h3>Admin Panel</h3>
        </div>
        <nav class="sidebar-nav">
            <a href="/admin/dashboard" class="active">
                <i class="fas fa-chart-line"></i>
                Dashboard
            </a>
            <a href="/admin/users">
                <i class="fas fa-users"></i>
                Users
            </a>
            <a href="/admin/security">
                <i class="fas fa-lock"></i>
                Security
            </a>
            <a href="/admin/logs">
                <i class="fas fa-history"></i>
                Activity Logs
            </a>
            <a href="/admin/settings">
                <i class="fas fa-cog"></i>
                Settings
            </a>
        </nav>
    </div>

    <!-- Debug info to see if data is passing -->
    <div style="display: none;">
        Data check: {{ stats }}
    </div>

    <div class="admin-main">
        <div class="admin-header">
            <h2>Security Dashboard</h2>
            <div class="header-actions">
                <div class="alert-indicator {% if critical_alerts | selectattr('acknowledged', 'equalto', false) | list | length > 0 %}alert-active{% endif %}">
                    <i class="fas fa-bell"></i>
                    <span class="alert-count">{{ critical_alerts | selectattr('acknowledged', 'equalto', false) | list | length }}</span>
                </div>
                <button class="btn-secondary" onclick="refreshStats()">
                    <i class="fas fa-sync"></i> Refresh
                </button>
                <div class="date-filter">
                    <select id="timeRange" onchange="updateStats()">
                        <option value="today">Today</option>
                        <option value="week">This Week</option>
                        <option value="month">This Month</option>
                        <option value="quarter">This Quarter</option>
                    </select>
                </div>
            </div>
        </div>

        <!-- System Status Banner -->
        {% if system_status %}
        <div class="system-status {{ system_status.level }}">
            <i class="fas fa-{% if system_status.level == 'normal' %}check-circle{% else %}exclamation-triangle{% endif %}"></i>
            <span>System Status: {{ system_status.message }}</span>
            {% if system_status.level != 'normal' %}
            <button class="btn-small" onclick="showSystemDetails()">View Details</button>
            {% endif %}
        </div>
        {% else %}
        <div class="system-status normal">
            <i class="fas fa-check-circle"></i>
            <span>System Status: All systems operational</span>
        </div>
        {% endif %}

        <!-- Key Metrics Overview -->
        <div class="stats-grid">
            <div class="stat-card">
                <div class="stat-title">Total Users</div>
                <div class="stat-value">{{ stats.total_users if stats else 0 }}</div>
                <div class="stat-extra positive">+{{ stats.new_users_today if stats else 0 }} today</div>
            </div>
            
            <div class="stat-card">
                <div class="stat-title">Active Sessions</div>
                <div class="stat-value">{{ stats.active_sessions if stats else 0 }}</div>
                <div class="stat-extra">{{ stats.total_sessions_day if stats else 0 }} total today</div>
            </div>
            
            <div class="stat-card">
                <div class="stat-title">Security Events (24h)</div>
                <div class="stat-value">{{ security_metrics.unique_failed_ips_day if security_metrics else 0 }}</div>
                <div class="stat-extra negative">{{ critical_alerts | selectattr('acknowledged', 'equalto', false) | list | length }} unack. alerts</div>
            </div>
            
            <div class="stat-card">
                <div class="stat-title">Login Attempts (24h)</div>
                <div class="stat-value">{{ stats.total_logins_day if stats else 0 }}</div>
                <div class="stat-extra negative">{{ stats.failed_logins_day if stats else 0 }} failed</div>
            </div>
        </div>

        <!-- Security Overview -->
        <div class="dashboard-section">
            <div class="section-header">
                <h3><i class="fas fa-shield-alt"></i> Security Overview</h3>
                <button class="btn-small" onclick="location.href='/admin/settings'">View All</button>
            </div>
            
            <div class="security-grid">
                <div class="security-card {% if security_metrics and security_metrics.login_failure_rate_day > 20 %}alert{% endif %}">
                    <h4>Login Failure Rate (24h)</h4>
                    <div class="metric-circle">
                        <span>{% if security_metrics %}{{ security_metrics.login_failure_rate_day }}{% else %}0{% endif %}%</span>
                    </div>
                    <p>Compared to 5% benchmark</p>
                </div>
                
                <div class="security-card {% if security_metrics and security_metrics.blocked_ips_count > 10 %}alert{% endif %}">
                    <h4>Blocked IPs</h4>
                    <div class="metric-value">
                        <i class="fas fa-ban"></i>
                        <span>{% if security_metrics %}{{ security_metrics.blocked_ips_count }}{% else %}0{% endif %}</span>
                    </div>
                    <p>Total blocked</p>
                </div>
                
                <div class="security-card {% if security_metrics and security_metrics.mfa_adoption_rate < 70 %}alert{% endif %}">
                    <h4>MFA Adoption</h4>
                    <div class="metric-circle">
                        <span>{% if security_metrics %}{{ security_metrics.mfa_adoption_rate }}{% else %}0{% endif %}%</span>
                    </div>
                    <p>Target: 90%</p>
                </div>
                
                <div class="security-card {% if security_metrics and security_metrics.compliance_score is defined and security_metrics.compliance_score < 80 %}alert{% endif %}">
                    <h4>Compliance Score</h4>
                    <div class="metric-circle">
                        <span>{% if security_metrics and security_metrics.compliance_score is defined %}{{ security_metrics.compliance_score }}{% else %}N/A{% endif %}</span>
                    </div>
                    <p>Issues: N/A</p>
                </div>
            </div>
        </div>

        <!-- Real-time Monitoring -->
        <div class="charts-row">
            <div class="chart-card">
                <h3>User Activity Trends</h3>
                <div class="chart-container">
                    <canvas id="userActivityChart"></canvas>
                </div>
            </div>

            <div class="chart-card">
                <h3>Security Incidents</h3>
                <div class="chart-container">
                    <canvas id="securityChart"></canvas>
                </div>
            </div>
        </div>

        <div class="charts-row">
            <div class="chart-card">
                <h3>Geographic Login Distribution</h3>
                <div class="chart-container">
                    <canvas id="geoChart"></canvas>
                </div>
            </div>

            <div class="chart-card">
                <h3>System Resource Usage</h3>
                <div class="chart-container">
                    <canvas id="resourceChart"></canvas>
                </div>
            </div>
        </div>

        <!-- Critical Alerts -->
        <div class="dashboard-section">
            <div class="section-header">
                <h3><i class="fas fa-exclamation-circle"></i> Critical Alerts</h3>
                <button class="btn-small" onclick="acknowledgeAllAlerts()">Acknowledge All</button>
            </div>
            
            <div class="alerts-container {% if not critical_alerts %}empty{% endif %}">
                {% if critical_alerts %}
                    {% for alert in critical_alerts %}
                    <div class="alert-card severity-{{ alert.severity | lower }} {% if alert.acknowledged %}acknowledged{% endif %}">
                        <div class="alert-header">
                            <i class="fas fa-{{ alert.icon | default('exclamation-triangle') }}"></i>
                            <h4>{{ alert.title | default(alert.message) }}</h4>
                            <span class="alert-time">{{ alert.timestamp | default('-') }}</span>
                        </div>
                        <p class="alert-message">{{ alert.message }}</p>
                        <div class="alert-actions">
                            <button class='btn-small'
                                    data-details='{{ alert.details | default("No details available.") | tojson }}'
                                    onclick='viewAlertDetails("{{ alert.id }}", this)'>Details</button>
                            {% if not alert.acknowledged %}
                            <button class='btn-small' onclick='acknowledgeAlert("{{ alert.id }}")'>Acknowledge</button>
                            {% endif %}
                        </div>
                    </div>
                    {% endfor %}
                {% else %}
                    <div class="no-alerts">
                        <i class="fas fa-check-circle"></i>
                        <p>No critical alerts at this time.</p>
                    </div>
                {% endif %}
            </div>
        </div>

        <!-- Recent Activity -->
        <div class="dashboard-section">
            <div class="section-header">
                <h3><i class="fas fa-history"></i> Recent Activity</h3>
                <button class="btn-small" onclick="location.href='/admin/logs'">View All Logs</button>
            </div>
            
            <div class="recent-activity">
                <div class="activity-list">
                    {% if recent_activity %}
                    {% for activity in recent_activity %}
                    <div class="activity-item">
                        <div class="activity-icon {{ activity.type | default('info') }}">
                            <i class="fas fa-{{ activity.icon | default('info-circle') }}"></i>
                        </div>
                        <div class="activity-details">
                            <p class="activity-text">{{ activity.description | default(activity.action) }}</p>
                            <p class="activity-time">{{ activity.timestamp }}</p>
                        </div>
                        <div class="activity-status {{ activity.status | default('info') }}">
                            {{ activity.status | default('info') }}
                        </div>
                    </div>
                    {% endfor %}
                    {% else %}
                    <div class="activity-item">
                        <div class="activity-icon">
                            <i class="fas fa-info-circle"></i>
                        </div>
                        <div class="activity-details">
                            <p class="activity-text">No recent activity to display</p>
                            <p class="activity-time">-</p>
                        </div>
                        <div class="activity-status">
                            info
                        </div>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>

        <!-- Quick Actions -->
        <div class="dashboard-section">
            <div class="section-header">
                <h3><i class="fas fa-bolt"></i> Quick Actions</h3>
            </div>
            
            <div class="quick-actions">
                <button class="action-button" onclick="lockdownSystem()">
                    <i class="fas fa-lock"></i>
                    <span>Lockdown System</span>
                </button>
                <button class="action-button" onclick="runSecurityScan()">
                    <i class="fas fa-search"></i>
                    <span>Run Security Scan</span>
                </button>
                <button class="action-button" onclick="createBackup()">
                    <i class="fas fa-database"></i>
                    <span>Create Backup</span>
                </button>
                <button class="action-button" onclick="generateReport()">
                    <i class="fas fa-file-alt"></i>
                    <span>Generate Report</span>
                </button>
                <button class="action-button" onclick="location.href='/admin/settings'">
                    <i class="fas fa-cogs"></i>
                    <span>Security Policies</span>
                </button>
                <button class="action-button" onclick="invalidateSessions()">
                    <i class="fas fa-user-slash"></i>
                    <span>Invalidate Sessions</span>
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Modals -->
<div id="alertModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h3 id="modalTitle">Alert Details</h3>
            <span class="close-modal" onclick="closeModal('alertModal')">&times;</span>
        </div>
        <div class="modal-body" id="modalBody">
            <!-- Alert details will be injected here -->
        </div>
        <div class="modal-footer">
            <button class="btn-primary" onclick="resolveAlert()">Mark as Resolved</button>
            <button class="btn-secondary" onclick="closeModal('alertModal')">Close</button>
        </div>
    </div>
</div>

<div id="systemDetailsModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h3>System Status Details</h3>
            <span class="close-modal" onclick="closeModal('systemDetailsModal')">&times;</span>
        </div>
        <div class="modal-body">
            <div class="system-metrics">
                <div class="metric-row">
                    <div class="metric-label">CPU Usage:</div>
                    <div class="metric-value">{% if system_status and system_status.cpu_usage %}{{ system_status.cpu_usage }}{% else %}0{% endif %}%</div>
                    <div class="progress-bar">
                        <div class="progress admin-progress-bar"></div>
                    </div>
                </div>
                <div class="metric-row">
                    <div class="metric-label">Memory Usage:</div>
                    <div class="metric-value">{% if system_status and system_status.memory_usage %}{{ system_status.memory_usage }}{% else %}0{% endif %}%</div>
                    <div class="progress-bar">
                        <div class="progress admin-memory-bar"></div>
                    </div>
                </div>
                <div class="metric-row">
                    <div class="metric-label">Disk Space:</div>
                    <div class="metric-value">{% if system_status and system_status.disk_usage %}{{ system_status.disk_usage }}{% else %}0{% endif %}%</div>
                    <div class="progress-bar">
                        <div class="progress admin-disk-bar"></div>
                    </div>
                </div>
                <div class="metric-row">
                    <div class="metric-label">Database Connections:</div>
                    <div class="metric-value">{% if system_status and system_status.db_connections %}{{ system_status.db_connections }}{% else %}0{% endif %}/{% if system_status and system_status.max_db_connections %}{{ system_status.max_db_connections }}{% else %}100{% endif %}</div>
                </div>
                <div class="metric-row">
                    <div class="metric-label">API Response Time:</div>
                    <div class="metric-value">{% if system_status and system_status.api_response_time %}{{ system_status.api_response_time }}{% else %}0{% endif %}ms</div>
                </div>
            </div>
            
            <div class="system-issues">
                <h4>Active Issues</h4>
                {% if system_status and system_status.issues %}
                    <ul class="issues-list">
                    {% for issue in system_status.issues %}
                        <li class="{{ issue.severity }}">
                            <span class="issue-type">{{ issue.type }}</span>
                            <span class="issue-message">{{ issue.message }}</span>
                        </li>
                    {% endfor %}
                    </ul>
                {% else %}
                    <p>No active issues detected.</p>
                {% endif %}
            </div>
        </div>
        <div class="modal-footer">
            <button class="btn-primary" onclick="runSystemDiagnostics()">Run Diagnostics</button>
            <button class="btn-secondary" onclick="closeModal('systemDetailsModal')">Close</button>
        </div>
    </div>
</div>

<!-- Store data for JavaScript in hidden elements -->
<div id="dashboard-data" style="display:none;"
    data-cpu-usage="{% if system_status and system_status.cpu_usage %}{{ system_status.cpu_usage }}{% else %}0{% endif %}"
    data-memory-usage="{% if system_status and system_status.memory_usage %}{{ system_status.memory_usage }}{% else %}0{% endif %}"
    data-disk-usage="{% if system_status and system_status.disk_usage %}{{ system_status.disk_usage }}{% else %}0{% endif %}">
</div>
{% endblock %}

{% block scripts %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
document.addEventListener('DOMContentLoaded', function() {
    try {
        console.log("Initializing admin dashboard...");
        
        // Initialize progress bars with data from the template
        const dashboardData = document.getElementById('dashboard-data');
        if (dashboardData) {
            // Update progress bars
            const cpuUsage = dashboardData.getAttribute('data-cpu-usage');
            const memoryUsage = dashboardData.getAttribute('data-memory-usage');
            const diskUsage = dashboardData.getAttribute('data-disk-usage');
            
            // Update CPU progress bar
            const cpuBar = document.querySelector('.admin-progress-bar');
            if (cpuBar) cpuBar.style.width = cpuUsage + '%';
            
            // Update memory progress bar
            const memoryBar = document.querySelector('.admin-memory-bar');
            if (memoryBar) memoryBar.style.width = memoryUsage + '%';
            
            // Update disk progress bar
            const diskBar = document.querySelector('.admin-disk-bar');
            if (diskBar) diskBar.style.width = diskUsage + '%';
            
            console.log("Progress bars initialized with:", {
                cpu: cpuUsage + '%',
                memory: memoryUsage + '%',
                disk: diskUsage + '%'
            });
        }
        
        // Initialize charts with error handling
        function initCharts() {
            try {
                // Make sure all chart canvases exist before initializing
                const chartElements = [
                    'userActivityChart',
                    'securityChart',
                    'geoChart',
                    'resourceChart'
                ];
                
                // Check if all elements exist
                for (const id of chartElements) {
                    const element = document.getElementById(id);
                    if (!element) {
                        console.error(`Chart element #${id} not found`);
                        continue;
                    }
                }
                
                // User Activity Chart
                if (document.getElementById('userActivityChart')) {
                    const userCtx = document.getElementById('userActivityChart').getContext('2d');
                    new Chart(userCtx, {
                        type: 'line',
                        data: {
                            labels: ['Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat', 'Sun'],
                            datasets: [{
                                label: 'Active Users',
                                data: [65, 59, 80, 81, 56, 55, 40],
                                borderColor: '#3498db',
                                tension: 0.4,
                                fill: false
                            }, {
                                label: 'Authentication Failures',
                                data: [10, 15, 8, 12, 17, 14, 9],
                                borderColor: '#e74c3c',
                                tension: 0.4,
                                fill: false
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false
                        }
                    });
                }

                // Security Incidents Chart
                if (document.getElementById('securityChart')) {
                    const securityCtx = document.getElementById('securityChart').getContext('2d');
                    new Chart(securityCtx, {
                        type: 'bar',
                        data: {
                            labels: ['Failed Logins', 'Suspicious IPs', 'MFA Failures', 'Password Attempts', 'Brute Force'],
                            datasets: [{
                                label: 'Incidents',
                                data: [12, 19, 3, 5, 8],
                                backgroundColor: '#e74c3c'
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false
                        }
                    });
                }
                
                // Geographic Chart
                if (document.getElementById('geoChart')) {
                    const geoCtx = document.getElementById('geoChart').getContext('2d');
                    new Chart(geoCtx, {
                        type: 'pie',
                        data: {
                            labels: ['North America', 'Europe', 'Asia', 'South America', 'Africa', 'Australia'],
                            datasets: [{
                                data: [45, 25, 15, 8, 5, 2],
                                backgroundColor: [
                                    '#3498db', '#2ecc71', '#f1c40f', '#e67e22', '#e74c3c', '#9b59b6'
                                ]
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false
                        }
                    });
                }
                
                // System Resources Chart
                if (document.getElementById('resourceChart')) {
                    const resourceCtx = document.getElementById('resourceChart').getContext('2d');
                    new Chart(resourceCtx, {
                        type: 'line',
                        data: {
                            labels: ['00:00', '04:00', '08:00', '12:00', '16:00', '20:00', '23:59'],
                            datasets: [{
                                label: 'CPU Usage (%)',
                                data: [35, 40, 60, 75, 65, 70, 45],
                                borderColor: '#3498db',
                                tension: 0.4,
                                fill: false
                            }, {
                                label: 'Memory Usage (%)',
                                data: [50, 55, 65, 70, 75, 70, 60],
                                borderColor: '#2ecc71',
                                tension: 0.4,
                                fill: false
                            }, {
                                label: 'Disk I/O (MB/s)',
                                data: [15, 20, 30, 35, 28, 25, 18],
                                borderColor: '#f1c40f',
                                tension: 0.4,
                                fill: false
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false
                        }
                    });
                }
            } catch (error) {
                console.error('Error initializing charts:', error);
            }
        }

        // Initialize charts when the page loads
        initCharts();

        // Make functions globally available
        window.refreshStats = function refreshStats() {
            // Add your refresh logic here
            console.log('Refreshing stats...');
            // Show loading indicator
            document.querySelector('.admin-header').classList.add('loading');
            // Simulate API call
            setTimeout(() => {
                document.querySelector('.admin-header').classList.remove('loading');
                alert('Dashboard data refreshed');
            }, 1000);
        };

        window.updateStats = function updateStats() {
            const timeRange = document.getElementById('timeRange').value;
            // Add your update logic here
            console.log('Updating stats for:', timeRange);
            // Show loading indicator
            document.querySelector('.admin-header').classList.add('loading');
            // Simulate API call
            setTimeout(() => {
                document.querySelector('.admin-header').classList.remove('loading');
                alert('Dashboard updated for time range: ' + timeRange);
            }, 1000);
        };

        window.viewAlertDetails = function viewAlertDetails(alertId, buttonElement) {
            console.log('Viewing alert:', alertId);
            const details = JSON.parse(buttonElement.getAttribute('data-details') || '"No details available."');
            
            document.getElementById('modalTitle').innerText = 'Alert Details: #' + alertId;
            const formattedDetails = details.replace(/\n/g, '<br>');
            document.getElementById('modalBody').innerHTML = `<pre>${escapeHtml(formattedDetails)}</pre>`; 
            document.getElementById('alertModal').style.display = 'block';
        };

        window.acknowledgeAlert = function acknowledgeAlert(alertId) {
            console.log('Acknowledging alert:', alertId);
            const alertCard = document.querySelector(`.alert-card button[onclick^="acknowledgeAlert('${alertId}')"]`).closest('.alert-card');
            if (alertCard) {
                alertCard.classList.add('acknowledged');
                const ackButton = alertCard.querySelector('button[onclick^="acknowledgeAlert"]');
                if (ackButton) ackButton.remove();
                const countElement = document.querySelector('.alert-indicator .alert-count');
                let currentCount = parseInt(countElement.textContent || '0');
                if (currentCount > 0) countElement.textContent = currentCount - 1;
                if (currentCount -1 <= 0) document.querySelector('.alert-indicator').classList.remove('alert-active');
            } else {
                console.warn("Could not find alert card for ID:", alertId);
            }
        };

        window.acknowledgeAllAlerts = function acknowledgeAllAlerts() {
            console.log('Acknowledging all alerts');
            alert('All alerts acknowledged');
            document.querySelector('.alerts-container').innerHTML = `
                <div class="no-alerts">
                    <i class="fas fa-check-circle"></i>
                    <p>No critical alerts at this time.</p>
                </div>
            `;
            document.querySelector('.alerts-container').classList.add('empty');
        };

        window.showSystemDetails = function showSystemDetails() {
            document.getElementById('systemDetailsModal').style.display = 'block';
        };

        window.closeModal = function closeModal(modalId) {
            document.getElementById(modalId).style.display = 'none';
        };

        window.resolveAlert = function resolveAlert() {
            alert('Alert marked as resolved');
            closeModal('alertModal');
        };

        window.runSystemDiagnostics = function runSystemDiagnostics() {
            alert('System diagnostics initiated');
        };

        window.lockdownSystem = function lockdownSystem() {
            if (confirm('WARNING: This will lock all user accounts and invalidate all sessions. Continue?')) {
                alert('System lockdown initiated');
            }
        };

        window.runSecurityScan = function runSecurityScan() {
            alert('Security scan initiated');
        };

        window.createBackup = function createBackup() {
            alert('System backup initiated');
        };

        window.generateReport = function generateReport() {
            alert('Security report generation initiated');
        };

        window.invalidateSessions = function invalidateSessions() {
            if (confirm('This will invalidate all active user sessions. Continue?')) {
                alert('All sessions invalidated. Users will need to log in again.');
            }
        };

        // Close modals when clicking outside
        window.onclick = function(event) {
            const modals = document.getElementsByClassName('modal');
            for (let i = 0; i < modals.length; i++) {
                if (event.target == modals[i]) {
                    modals[i].style.display = 'none';
                }
            }
        };

        // Add escapeHtml utility function if not present
        if (typeof escapeHtml === 'undefined') {
            window.escapeHtml = function(unsafe) {
                if (!unsafe) return '';
                return unsafe
                     .replace(/&/g, "&amp;")
                     .replace(/</g, "&lt;")
                     .replace(/>/g, "&gt;")
                     .replace(/"/g, "&quot;")
                     .replace(/'/g, "&#039;");
            }
        }

        console.log("Admin dashboard initialization complete!");
    } catch (error) {
        console.error("Fatal error initializing admin dashboard:", error);
        document.body.innerHTML += `
            <div style="position:fixed; top:0; left:0; right:0; background:red; color:white; padding:20px; z-index:10000">
                JavaScript Error: ${error.message}<br>
                <pre>${error.stack}</pre>
            </div>
        `;
    }
});
</script>
{% endblock %}
